<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: NewsController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: NewsController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { News } from "./db.js";
import { EventEmitter } from "events";

const emitter = new EventEmitter();
/**
 * Контроллер с API для работы с новостями
 * */
class NewsController {
  /** API для получения уведолмений о создании, публикации, изменении и удалении новостей. Работает как event sourcing, поодерживает постоянное подключение и в реальном времени выводит сообщения о событиях. Get-запрос на http://localhost:3011/api/newsNotice
   */
  newsNotice(req, res) {
    res.writeHead(200, {
      Connection: "keep-alive",
      "Content-type": "text/event-stream",
      "Cache-Control": "no-cache",
    });
    emitter.on("newsChanges", (message) => {
      res.write(`data: ${JSON.stringify(message)} \n\n`);
    });
  }
  /** API для получения всех новостей из БД (даже неопубликованных) через get-запрос на http://localhost:3011/api/newsAll .
   * */
  newsAll(req, res, next) {
    News.all((err, news) => {
      if (err) return next(err);
      res.send(news);
    });
  }
  /** API для создания новости через post-запрос.
   *
   * @example
   * передача данных в формате json на http://localhost:3011/api/create :
   * {
   *     "title": "title",
   *     "content": "some content",
   *     "author": "author"
   * }
   * // => "ok"
   * */
  create(req, res, next) {
    const data = req.body;
    News.create(data, (err) => {
      if (err) return next(err);
      emitter.emit("newsChanges", "News were created");
      res.send("ok");
    });
  }
  /** API для публикации новости в настоящее время через post-запрос/
   *
   * @example
   * передача данных в формате json на http://localhost:3011/api/publicate :
   * {
   *     "id": 1
   * }
   * // => "ok"
   * */
  publicate(req, res, next) {
    const data = req.body;
    News.publicate(data.id, (err) => {
      if (err) return next(err);
      emitter.emit("newsChanges", "News were publicated");
      res.send("ok");
    });
  }
  /** API для отложенной публикации новости. При вызове функции через post-запрос.
   *
   * @example
   * передача данных в формате json на http://localhost:3011/api/publicate_on_time :
   * {
   *     "id": 1,
   *     "date_published": "2023-11-01T18:26:00"
   * }
   * // => "ok"
   * */
  publicate_on_time(req, res, next) {
    const data = req.body;
    const date_publicate = new Date(data.date_published);
    const date_now = new Date();
    const timeDiff = date_publicate.getTime() - date_now.getTime();
    if (timeDiff > 0) {
      setTimeout(function () {
        News.publicate(data.id, (err) => {
          if (err) return next(err);
          emitter.emit(
            "newsChanges",
            `News were publicated on time ${data.date}`
          );
          res.send("ok");
        });
      }, timeDiff);
    } else {
      res.send("Указанная дата уже прошла!");
    }
  }
  /** API для редактирования новости. При вызове функции через post-запрос.
   *
   * @example
   * передача данных в формате json на http://localhost:3011/api/update :
   * {
   *     "title": "qqqq",
   *     "content": "qqqqqqqqqq",
   *     "author": "ddd"
   * }
   * // => "ok"
   * */
  update(req, res, next) {
    const id = req.body.id;
    const data = req.body;
    News.update(data, id, (err) => {
      if (err) return next(err);
      emitter.emit("newsChanges", "News were updated");
      res.send("ok");
    });
  }
  /** API для удаления новости. При вызове функции через delete-запрос.
   *
   * @example
   * передача данных в формате ссылке:
   * http://localhost:3011/api/delete/4
   * // => "Deleted"
   * */
  delete(req, res, next) {
    const id = req.params.id;
    News.delete(id, (err) => {
      if (err) return next(err);
      emitter.emit("newsChanges", "News were deleted");
      res.send({ message: "Deleted" });
    });
  }
}

export default new NewsController();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="NewsController.html">NewsController</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Thu Nov 02 2023 20:08:24 GMT+0700 (GMT+07:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
